name: æ··æ·†JavaScriptä»£ç 
on:
  workflow_dispatch:
    inputs:
      obfuscation_level:
        description: 'æ··æ·†å¼ºåº¦çº§åˆ«'
        required: false
        default: 'high'
        type: choice
        options:
        - low
        - medium
        - high
        - maximum

jobs:
  obfuscate:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: å®‰è£…JavaScriptæ··æ·†å™¨
        run: npm install -g javascript-obfuscator

      - name: è®¾ç½®æ–‡ä»¶è·¯å¾„å˜é‡
        run: |
          echo "SOURCE_FILE=vlessæ— éœ€proxyipçš„nat64å¥—å£³ç‰ˆ (æ¨èä½¿ç”¨).js" >> $GITHUB_ENV
          echo "BACKUP_FILE=vlessæ— éœ€proxyipçš„nat64å¥—å£³ç‰ˆ (æ¨èä½¿ç”¨).js.backup" >> $GITHUB_ENV
          echo "TEMP_FILE=temp_worker.js" >> $GITHUB_ENV

      - name: éªŒè¯æºæ–‡ä»¶å­˜åœ¨
        run: |
          if [[ ! -f "$SOURCE_FILE" ]]; then
            echo "âŒ é”™è¯¯: æºæ–‡ä»¶ '$SOURCE_FILE' ä¸å­˜åœ¨!"
            echo "ğŸ“ å½“å‰ç›®å½•æ–‡ä»¶åˆ—è¡¨:"
            ls -la *.js 2>/dev/null || echo "æœªæ‰¾åˆ°ä»»ä½•.jsæ–‡ä»¶"
            exit 1
          fi
          echo "âœ… æºæ–‡ä»¶å­˜åœ¨: $SOURCE_FILE"

      - name: åˆ›å»ºå¤‡ä»½æ–‡ä»¶
        run: |
          if [[ ! -f "$BACKUP_FILE" ]]; then
            echo "ğŸ“‹ åˆ›å»ºå¤‡ä»½æ–‡ä»¶..."
            cp "$SOURCE_FILE" "$BACKUP_FILE"
            echo "âœ… å¤‡ä»½æ–‡ä»¶å·²åˆ›å»º: $BACKUP_FILE"
          else
            echo "ğŸ“‹ å¤‡ä»½æ–‡ä»¶å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º"
          fi
          
          # ä»å¤‡ä»½æ–‡ä»¶åˆ›å»ºä¸´æ—¶å·¥ä½œæ–‡ä»¶
          cp "$BACKUP_FILE" "$TEMP_FILE"

      - name: è®¾ç½®æ··æ·†å‚æ•°
        run: |
          case "${{ github.event.inputs.obfuscation_level }}" in
            "low")
              echo "OBFUSCATE_OPTIONS=--compact true --string-array true" >> $GITHUB_ENV
              ;;
            "medium")
              echo "OBFUSCATE_OPTIONS=--compact true --control-flow-flattening true --string-array true --string-array-encoding base64" >> $GITHUB_ENV
              ;;
            "high")
              echo "OBFUSCATE_OPTIONS=--compact true --control-flow-flattening true --control-flow-flattening-threshold 0.8 --dead-code-injection true --dead-code-injection-threshold 0.5 --identifier-names-generator hexadecimal --string-array true --string-array-encoding rc4 --string-array-threshold 0.8 --transform-object-keys true" >> $GITHUB_ENV
              ;;
            "maximum")
              echo "OBFUSCATE_OPTIONS=--compact true --control-flow-flattening true --control-flow-flattening-threshold 1 --dead-code-injection true --dead-code-injection-threshold 1 --identifier-names-generator hexadecimal --rename-globals true --string-array true --string-array-encoding rc4 --string-array-threshold 1 --transform-object-keys true --unicode-escape-sequence true --self-defending true" >> $GITHUB_ENV
              ;;
            *)
              echo "OBFUSCATE_OPTIONS=--compact true --control-flow-flattening true --string-array true --string-array-encoding rc4" >> $GITHUB_ENV
              ;;
          esac

      - name: æ‰§è¡Œä»£ç æ··æ·†
        run: |
          echo "ğŸ”„ å¼€å§‹æ··æ·†ä»£ç ... (çº§åˆ«: ${{ github.event.inputs.obfuscation_level || 'high' }})"
          
          javascript-obfuscator "$TEMP_FILE" --output "$SOURCE_FILE" $OBFUSCATE_OPTIONS
          
          if [[ $? -eq 0 ]]; then
            echo "âœ… ä»£ç æ··æ·†å®Œæˆ!"
            echo "ğŸ“Š æ··æ·†å‰æ–‡ä»¶å¤§å°: $(wc -c < "$BACKUP_FILE") å­—èŠ‚"
            echo "ğŸ“Š æ··æ·†åæ–‡ä»¶å¤§å°: $(wc -c < "$SOURCE_FILE") å­—èŠ‚"
          else
            echo "âŒ æ··æ·†å¤±è´¥!"
            exit 1
          fi

      - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        run: |
          rm -f "$TEMP_FILE"
          echo "ğŸ§¹ ä¸´æ—¶æ–‡ä»¶å·²æ¸…ç†"

      - name: éªŒè¯æ··æ·†ç»“æœ
        run: |
          if [[ ! -s "$SOURCE_FILE" ]]; then
            echo "âŒ è­¦å‘Š: æ··æ·†åçš„æ–‡ä»¶ä¸ºç©ºæˆ–ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "âœ… æ··æ·†æ–‡ä»¶éªŒè¯é€šè¿‡"
          echo "ğŸ“ æ··æ·†åæ–‡ä»¶å‰50ä¸ªå­—ç¬¦é¢„è§ˆ:"
          head -c 50 "$SOURCE_FILE"
          echo ""

      - name: é…ç½®Gitç”¨æˆ·
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: æäº¤æ··æ·†åçš„æ–‡ä»¶
        run: |
          git add "$SOURCE_FILE" "$BACKUP_FILE"
          
          if git diff --cached --quiet; then
            echo "ğŸ“ æ²¡æœ‰æ–‡ä»¶æ›´æ”¹ï¼Œè·³è¿‡æäº¤"
          else
            COMMIT_MSG="ğŸ”’ ä»£ç æ··æ·†å®Œæˆ - $(date '+%Y-%m-%d %H:%M:%S')
            
            ğŸ“ æ–‡ä»¶: $SOURCE_FILE
            ğŸ”§ æ··æ·†çº§åˆ«: ${{ github.event.inputs.obfuscation_level || 'high' }}
            ğŸ¤– è‡ªåŠ¨åŒ–æ“ä½œ: GitHub Actions
            ğŸ“‹ å¤‡ä»½æ–‡ä»¶: $BACKUP_FILE"
            
            git commit -m "$COMMIT_MSG"
            echo "âœ… æ–‡ä»¶å·²æäº¤åˆ°Git"
          fi

      - name: æ¨é€æ›´æ”¹åˆ°ä»“åº“
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}

      - name: è¾“å‡ºæ‰§è¡Œæ‘˜è¦
        run: |
          echo "ğŸ‰ æ··æ·†ä»»åŠ¡æ‰§è¡Œå®Œæ¯•!"
          echo ""
          echo "ğŸ“‹ æ‰§è¡Œæ‘˜è¦:"
          echo "â”œâ”€ ğŸ“ æºæ–‡ä»¶: $SOURCE_FILE"
          echo "â”œâ”€ ğŸ“ å¤‡ä»½æ–‡ä»¶: $BACKUP_FILE"
          echo "â”œâ”€ ğŸ”§ æ··æ·†çº§åˆ«: ${{ github.event.inputs.obfuscation_level || 'high' }}"
          echo "â”œâ”€ ğŸ“Š æ–‡ä»¶å¤§å°: $(wc -c < "$SOURCE_FILE") å­—èŠ‚"
          echo "â””â”€ â° å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo ""
          echo "ğŸ”— æŸ¥çœ‹æ›´æ”¹: https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
